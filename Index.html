<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c3e50">
    <meta name="description" content="CA Final Professional Offline Tracker - v20 Production">
    <title>CA Final Pro Tracker v20</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* =========================================
           CORE STYLES & CSS VARIABLES
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        }
        
        body { background-color: #f8fafc; color: #333; line-height: 1.6; overflow-x: hidden; padding-bottom: 50px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .hidden { display: none !important; }

        /* =========================================
           WELCOME / LICENSE SCREEN
           ========================================= */
        .welcome-container {
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background: var(--gradient); position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;
        }
        .welcome-box {
            background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 24px;
            width: 100%; max-width: 500px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        }
        .license-input-group { margin: 25px 0; }
        .license-input {
            width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 12px;
            font-size: 18px; text-align: center; letter-spacing: 2px; text-transform: uppercase;
            margin-bottom: 15px; transition: border 0.3s;
        }
        .license-input:focus { border-color: var(--secondary); outline: none; }
        .license-btn {
            width: 100%; padding: 15px; background: var(--secondary); color: white; border: none;
            border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .license-btn:hover { background: #2980b9; transform: translateY(-2px); }
        .license-status { margin-top: 15px; font-weight: bold; min-height: 24px; }
        .license-status.error { color: var(--accent); }
        .license-status.success { color: var(--success); }

        /* =========================================
           MAIN APP HEADER & NAV
           ========================================= */
        .app-container { display: none; }
        
        header { background: white; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--secondary); }
        
        nav { background: var(--primary); position: sticky; top: 70px; z-index: 99; }
        .nav-links { display: flex; list-style: none; overflow-x: auto; padding: 5px 0; justify-content: center; }
        .nav-links a {
            display: flex; flex-direction: column; align-items: center; padding: 12px 20px;
            color: rgba(255, 255, 255, 0.7); text-decoration: none; font-weight: 600;
            transition: all 0.3s; font-size: 13px; border-radius: 8px; margin: 0 2px;
        }
        .nav-links a i { font-size: 18px; margin-bottom: 5px; }
        .nav-links a.active, .nav-links a:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-links a.active { border-bottom: 3px solid var(--secondary); }

        /* =========================================
           PAGES & CARDS
           ========================================= */
        .page { display: none; padding: 30px 0; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px;
            box-shadow: var(--shadow); border: 1px solid #f0f0f0;
        }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 24px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-accent { background: var(--accent); }
        .btn-warning { background: var(--warning); }
        
        /* =========================================
           SUBJECTS & TOPICS UI
           ========================================= */
        .subject-dropdown { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 16px; margin-bottom: 20px; }
        .topic-item { border: 1px solid #eee; border-radius: 12px; margin-bottom: 15px; overflow: hidden; background: white; transition: 0.3s; }
        .topic-item:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .topic-header { padding: 15px 20px; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .topic-header:hover { background: #f1f3f5; }
        .subtopic-list { display: none; padding: 15px 20px; border-top: 1px solid #eee; }
        .topic-item.expanded .subtopic-list { display: block; }
        .subtopic-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .subtopic-row:last-child { border-bottom: none; }
        
        .hour-input { width: 80px; padding: 8px; border: 2px solid #e9ecef; border-radius: 6px; text-align: center; font-weight: bold; }
        .hour-input:focus { border-color: var(--secondary); outline: none; }

        /* =========================================
           TARGETS / PLANNING UI (v20 Overhaul)
           ========================================= */
        .target-item { background: white; border: 1px solid #eee; border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: 0.3s; }
        .target-item:hover { border-color: var(--secondary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .target-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .target-meta { display: flex; gap: 20px; align-items: center; margin-bottom: 15px; font-size: 14px; color: var(--gray); }
        .target-inputs { display: flex; align-items: center; gap: 15px; }
        
        .action-area { margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; display: flex; justify-content: flex-end; }
        
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .badge-pending { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
        .badge-subject { background: var(--secondary); color: white; }

        /* =========================================
           KPI CARDS & CHARTS
           ========================================= */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: 16px; text-align: center; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--secondary); }
        .kpi-val { font-size: 32px; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .kpi-label { color: var(--gray); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }

        /* =========================================
           RESOURCES, VIDEOS, HISTORY
           ========================================= */
        .resource-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 15px; background: white; }
        .resource-icon { width: 40px; height: 40px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 18px; margin-right: 15px; }
        
        /* =========================================
           TOAST NOTIFICATION
           ========================================= */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background: #333; color: white;
            padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px;
            transform: translateY(150%); transition: transform 0.3s; z-index: 2000; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateY(0); }
        .toast i { color: var(--success); font-size: 20px; }

        /* =========================================
           MODALS
           ========================================= */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; animation: fadeIn 0.3s; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); }

        /* Responsive */
        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr; }
            .nav-links a span { display: none; }
            .nav-links a i { font-size: 20px; margin: 0; }
            .target-inputs { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>

    <div class="welcome-container" id="welcome-screen">
        <div class="welcome-box">
            <h1 style="color: var(--primary); margin-bottom: 10px;"><i class="fas fa-graduation-cap"></i> CA Final Pro v20</h1>
            <p style="color: var(--gray); margin-bottom: 30px;">Professional Study Tracker</p>
            
            <div class="license-input-group">
                <input type="text" id="license-input" class="license-input" placeholder="XXXX-XXXX-XXXX-C">
                <button class="license-btn" onclick="activateLicense()">ACTIVATE LICENSE</button>
            </div>
            
            <div id="license-status" class="license-status"></div>
            
            <div style="margin-top: 20px; font-size: 13px; color: #999;">
                <a href="#" onclick="useDemo()" style="color: #999;">Use Demo Mode</a>
            </div>
        </div>
    </div>

    <div class="app-container" id="app-container">
        <header>
            <div class="container header-content">
                <div class="logo"><i class="fas fa-chart-line"></i> CA Final Pro</div>
                <div style="font-size:14px; color:var(--success); font-weight:bold;">
                    <i class="fas fa-check-circle"></i> Licensed
                    <button onclick="logout()" style="background:none; border:none; margin-left:10px; cursor:pointer; color:var(--accent);"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </header>

        <nav>
            <div class="container">
                <div class="nav-links">
                    <a href="#" class="nav-link active" onclick="switchPage('dashboard')"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a>
                    <a href="#" class="nav-link" onclick="switchPage('subjects')"><i class="fas fa-book"></i> <span>Subjects</span></a>
                    <a href="#" class="nav-link" onclick="switchPage('targets')"><i class="fas fa-calendar-check"></i> <span>Targets</span></a>
                    <a href="#" class="nav-link" onclick="switchPage('videos')"><i class="fas fa-video"></i> <span>Videos</span></a>
                    <a href="#" class="nav-link" onclick="switchPage('resources')"><i class="fas fa-folder-open"></i> <span>Resources</span></a>
                    <a href="#" class="nav-link" onclick="showSettings()"><i class="fas fa-cog"></i> <span>Settings</span></a>
                </div>
            </div>
        </nav>

        <div class="container" style="padding-top: 30px;">
            
            <div id="dashboard-page" class="page active">
                <div class="page-header">
                    <h2 class="page-title">Performance Overview</h2>
                    <button class="btn btn-primary" onclick="updateDashboard()"><i class="fas fa-sync"></i> Refresh</button>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-val" id="kpi-hours">0</div>
                        <div class="kpi-label">Total Actual Hours</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-val" id="kpi-completion">0%</div>
                        <div class="kpi-label">Syllabus Complete</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-val" id="kpi-targets">0</div>
                        <div class="kpi-label">Targets Archived</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Progress Visualization</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>Data Management</h3>
                    <div style="display:flex; gap:10px; margin-top:15px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="backupData()"><i class="fas fa-download"></i> Backup Data</button>
                        <input type="file" id="restore-file" style="display:none;" onchange="restoreData(this)">
                        <button class="btn btn-warning" onclick="document.getElementById('restore-file').click()"><i class="fas fa-upload"></i> Restore</button>
                        <button class="btn btn-accent" onclick="resetApp()"><i class="fas fa-trash"></i> Reset All</button>
                    </div>
                </div>
            </div>

            <div id="subjects-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Syllabus Tracker</h2>
                    <button class="btn btn-primary" onclick="saveAllProgress()"><i class="fas fa-save"></i> Save All Progress</button>
                </div>

                <div class="card">
                    <select id="subject-select" class="subject-dropdown" onchange="renderSubjects()">
                        <option value="all">All Subjects</option>
                        <option value="paper1">Paper 1: FR</option>
                        <option value="paper2">Paper 2: AFM</option>
                        <option value="paper3">Paper 3: Audit</option>
                        <option value="paper4">Paper 4: DT</option>
                        <option value="paper5">Paper 5: IDT</option>
                        <option value="paper6">Paper 6: IBS</option>
                    </select>
                </div>
                <div id="subjects-list"></div>
            </div>

            <div id="targets-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Planning & Targets</h2>
                </div>

                <div class="card">
                    <h3><i class="fas fa-plus-circle"></i> Add New Target</h3>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-top:15px;">
                        <input type="text" id="t-topic" class="subject-dropdown" style="margin:0;" placeholder="Topic / Chapter Name">
                        <select id="t-subject" class="subject-dropdown" style="margin:0;">
                            <option value="paper1">FR</option>
                            <option value="paper2">AFM</option>
                            <option value="paper3">Audit</option>
                            <option value="paper4">DT</option>
                            <option value="paper5">IDT</option>
                            <option value="paper6">IBS</option>
                        </select>
                        <input type="number" id="t-planned" class="subject-dropdown" style="margin:0;" placeholder="Planned Hours">
                        <button class="btn btn-primary" onclick="addTarget()">Add Target</button>
                    </div>
                </div>

                <div id="active-targets-list"></div>

                <div class="card">
                    <h3><i class="fas fa-history"></i> Target History</h3>
                    <button class="btn btn-accent" style="float:right; margin-top:-30px;" onclick="clearHistory()">Clear</button>
                    <div id="history-list" style="max-height:300px; overflow-y:auto; margin-top:20px;"></div>
                </div>
            </div>

            <div id="videos-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Video Library</h2>
                    <button class="btn btn-primary" onclick="showAddModal('video')"><i class="fas fa-plus"></i> Add Video</button>
                </div>
                <div id="videos-list"></div>
            </div>

            <div id="resources-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">Study Resources</h2>
                    <button class="btn btn-primary" onclick="showAddModal('resource')"><i class="fas fa-plus"></i> Add Resource</button>
                </div>
                <div id="resources-list"></div>
            </div>
        </div>
    </div>

    <div id="add-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Item</h3>
                <button class="modal-close" onclick="closeModal('add-modal')">&times;</button>
            </div>
            <input type="hidden" id="modal-type">
            <input type="text" id="m-title" class="subject-dropdown" placeholder="Title">
            <input type="text" id="m-link" class="subject-dropdown" placeholder="Link (URL)">
            <select id="m-subject" class="subject-dropdown">
                <option value="paper1">FR</option>
                <option value="paper2">AFM</option>
                <option value="paper3">Audit</option>
                <option value="paper4">DT</option>
                <option value="paper5">IDT</option>
                <option value="paper6">IBS</option>
            </select>
            <button class="btn btn-success" style="width:100%" onclick="saveModalItem()">Save Item</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // ==========================================
        // 1. DATA & CONFIGURATION
        // ==========================================
        const syllabusData = {
            paper1: { name: "Paper 1: FR", weightage: 26, topics: [
                { name: "Introduction to GPFS", weightage: 12.5, subtopics: [{name: "Ind AS 1 basics", weight: 40}, {name: "Schedule III", weight: 60}] },
                { name: "Assets", weightage: 20, subtopics: [{name: "Ind AS 16 PPE", weight: 50}, {name: "Ind AS 116 Leases", weight: 50}] },
                { name: "Financial Instruments", weightage: 15, subtopics: [{name: "Recognition", weight: 50}, {name: "Derivatives", weight: 50}] }
            ]},
            paper2: { name: "Paper 2: AFM", weightage: 22, topics: [
                { name: "Forex", weightage: 25, subtopics: [{name: "Concepts", weight: 50}, {name: "Hedging", weight: 50}] },
                { name: "Derivatives", weightage: 20, subtopics: [{name: "Futures", weight: 50}, {name: "Options", weight: 50}] }
            ]},
            paper3: { name: "Paper 3: Audit", weightage: 20, topics: [{ name: "Standards", weightage: 50, subtopics: [{name: "SA 500", weight: 100}] }] },
            paper4: { name: "Paper 4: DT", weightage: 16, topics: [{ name: "PGBP", weightage: 30, subtopics: [{name: "Sec 32", weight: 100}] }] },
            paper5: { name: "Paper 5: IDT", weightage: 12, topics: [{ name: "GST", weightage: 50, subtopics: [{name: "ITC", weight: 100}] }] },
            paper6: { name: "Paper 6: IBS", weightage: 4, topics: [{ name: "Case Studies", weightage: 100, subtopics: [{name: "Integrated", weight: 100}] }] }
        };

        // State Storage
        let appData = {
            plan: { totalHours: 740, subjectHours: { paper1: 180, paper2: 160, paper3: 140, paper4: 120, paper5: 100, paper6: 40 } },
            progress: {},
            targets: [],
            history: [],
            videos: [],
            resources: []
        };
        
        let chartInstance = null;

        // ==========================================
        // 2. LICENSE LOGIC (v20 WEIGHTED MODULO-36)
        // ==========================================
        function activateLicense() {
            const input = document.getElementById('license-input');
            const status = document.getElementById('license-status');
            const key = input.value.trim().toUpperCase();

            if (!key.includes('-')) {
                status.textContent = "Invalid Format. Use XXXX-XXXX-XXXX-C";
                status.className = "license-status error";
                return;
            }

            const lastDash = key.lastIndexOf('-');
            const payload = key.substring(0, lastDash);
            const checkChar = key.substring(lastDash + 1);
            
            // v20 Checksum Logic
            const rawPayload = payload.replace(/-/g, '');
            let sum = 0;
            for (let i = 0; i < rawPayload.length; i++) {
                sum += rawPayload.charCodeAt(i) * (i + 1);
            }
            const calculated = (sum % 36).toString(36).toUpperCase();

            if (checkChar === calculated) {
                localStorage.setItem('v20_license', 'active');
                initApp();
            } else {
                status.textContent = "Invalid Key. Checksum mismatch.";
                status.className = "license-status error";
            }
        }

        function useDemo() {
            localStorage.setItem('v20_license', 'demo');
            initApp();
        }

        function logout() {
            localStorage.removeItem('v20_license');
            location.reload();
        }

        // ==========================================
        // 3. CORE FUNCTIONS
        // ==========================================
        function initApp() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            loadData();
            renderSubjects();
            renderTargets();
            renderResources();
            updateDashboard();
        }

        function loadData() {
            const saved = localStorage.getItem('v20_data');
            if (saved) appData = JSON.parse(saved);
        }

        function saveData() {
            localStorage.setItem('v20_data', JSON.stringify(appData));
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ==========================================
        // 4. SUBJECTS (v20 WEIGHTED HOURS FIX)
        // ==========================================
        function renderSubjects() {
            const list = document.getElementById('subjects-list');
            const filter = document.getElementById('subject-select').value;
            list.innerHTML = '';

            Object.keys(syllabusData).forEach(subjId => {
                if (filter !== 'all' && filter !== subjId) return;
                const subj = syllabusData[subjId];
                if (!appData.progress[subjId]) appData.progress[subjId] = {};

                let html = `<div class="card">
                    <div class="page-header" style="margin-bottom:10px;">
                        <h3>${subj.name}</h3>
                        <span>Plan: ${appData.plan.subjectHours[subjId]}h</span>
                    </div>`;

                subj.topics.forEach(topic => {
                    html += `<div class="topic-item">
                        <div class="topic-header" onclick="this.parentElement.classList.toggle('expanded')">
                            <strong>${topic.name}</strong>
                            <span><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="subtopic-list">`;
                    
                    topic.subtopics.forEach(sub => {
                        const key = `${subjId}_${topic.name}_${sub.name}`.replace(/\s+/g, '');
                        const val = appData.progress[subjId][key] || 0;
                        html += `
                        <div class="subtopic-row">
                            <div style="flex:1">
                                <div>${sub.name}</div>
                                <small style="color:var(--gray)">Weight: ${sub.weight}% of Topic</small>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <input type="number" id="inp_${key}" class="hour-input" value="${val}" onchange="autoSave('${subjId}','${key}')">
                                <button class="btn btn-success" style="padding:5px 10px;" 
                                    onclick="markComplete('${subjId}', '${key}', ${sub.weight}, ${topic.weightage}, 'inp_${key}')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>`;
                    });
                    html += `</div></div>`;
                });
                html += `</div>`;
                list.innerHTML += html;
            });
        }

        // FIX: Calculate hours based on weightage if 0
        function markComplete(subjId, key, subWeight, topicWeight, inputId) {
            const input = document.getElementById(inputId);
            let val = parseFloat(input.value);
            
            if (!val || val === 0) {
                const total = appData.plan.subjectHours[subjId];
                // Formula: TotalPaperHrs * (TopicWeight/100) * (SubtopicWeight/100)
                const calc = (topicWeight/100) * (subWeight/100) * total;
                input.value = calc.toFixed(2);
                showToast(`Auto-calc: ${calc.toFixed(2)} hrs`);
            } else {
                showToast("Saved existing hrs");
            }
            autoSave(subjId, key);
        }

        function autoSave(subjId, key) {
            const val = parseFloat(document.getElementById(`inp_${key}`).value) || 0;
            if (!appData.progress[subjId]) appData.progress[subjId] = {};
            appData.progress[subjId][key] = val;
            saveData();
            updateDashboard();
        }

        // FIX: Filter 0 entries
        function saveAllProgress() {
            let count = 0;
            const inputs = document.querySelectorAll('.hour-input');
            inputs.forEach(inp => {
                if (parseFloat(inp.value) > 0) count++;
            });
            showToast(`Synced ${count} active entries`);
        }

        // ==========================================
        // 5. TARGETS (v20 UI OVERHAUL)
        // ==========================================
        function addTarget() {
            const topic = document.getElementById('t-topic').value;
            const planned = parseFloat(document.getElementById('t-planned').value);
            const subj = document.getElementById('t-subject').value;
            
            if (!topic || !planned) return alert("Enter topic and hours");

            appData.targets.push({
                id: Date.now(),
                topic,
                subject: subj,
                planned,
                actual: 0,
                date: new Date().toLocaleDateString()
            });
            
            saveData();
            renderTargets();
            showToast("Target Added");
            document.getElementById('t-topic').value = '';
            document.getElementById('t-planned').value = '';
        }

        function renderTargets() {
            const list = document.getElementById('active-targets-list');
            list.innerHTML = '';
            
            if(appData.targets.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">No active targets.</div>';
                return;
            }

            appData.targets.forEach((t, i) => {
                let actionHTML = '';
                
                // v20 Logic: Hide buttons if 0 hours
                if (t.actual === 0) {
                    actionHTML = `<span class="badge badge-pending"><i class="fas fa-clock"></i> Pending (0 hrs)</span>`;
                } else {
                    if (t.actual >= t.planned) {
                        actionHTML = `<button class="btn btn-success" onclick="archiveTarget(${i})"><i class="fas fa-check-circle"></i> Complete - Archive</button>`;
                    } else {
                        actionHTML = `<button class="btn btn-warning" onclick="archiveTarget(${i})"><i class="fas fa-exclamation-circle"></i> Partial - Archive</button>`;
                    }
                }

                list.innerHTML += `
                <div class="target-item">
                    <div class="target-header">
                        <strong>${t.topic}</strong>
                        <span class="badge badge-subject">${t.subject}</span>
                    </div>
                    <div class="target-meta">
                        <span>Planned: <b>${t.planned}h</b></span>
                        <div class="target-inputs">
                            <span>Actual:</span>
                            <input type="number" class="hour-input" value="${t.actual}" onchange="updateTargetHrs(${i}, this.value)">
                        </div>
                    </div>
                    <div class="action-area">${actionHTML}</div>
                </div>`;
            });

            // Render History
            const histList = document.getElementById('history-list');
            histList.innerHTML = appData.history.slice().reverse().map(h => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <div><b>${h.topic}</b> <br><small>${h.date}</small></div>
                    <div style="text-align:right">
                        ${h.actual}/${h.planned}h <br>
                        <span style="color:${h.status==='Complete'?'var(--success)':'var(--warning)'}">${h.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateTargetHrs(i, val) {
            appData.targets[i].actual = parseFloat(val) || 0;
            saveData();
            renderTargets(); // Re-render to show/hide buttons
        }

        function archiveTarget(i) {
            const t = appData.targets[i];
            t.status = t.actual >= t.planned ? 'Complete' : 'Partial';
            appData.history.push(t);
            appData.targets.splice(i, 1);
            saveData();
            renderTargets();
            updateDashboard();
            showToast("Target Archived");
        }

        function clearHistory() {
            if(confirm("Clear history?")) {
                appData.history = [];
                saveData();
                renderTargets();
                updateDashboard();
            }
        }

        // ==========================================
        // 6. RESOURCES & VIDEOS
        // ==========================================
        function showAddModal(type) {
            document.getElementById('add-modal').style.display = 'flex';
            document.getElementById('modal-type').value = type;
            document.getElementById('modal-title').textContent = type === 'video' ? 'Add Video' : 'Add Resource';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function saveModalItem() {
            const type = document.getElementById('modal-type').value;
            const title = document.getElementById('m-title').value;
            const link = document.getElementById('m-link').value;
            const subj = document.getElementById('m-subject').value;

            if(!title) return alert("Title required");

            const item = { title, link, subject: subj, id: Date.now() };
            if(type === 'video') appData.videos.push(item);
            else appData.resources.push(item);

            saveData();
            renderResources();
            closeModal('add-modal');
            showToast("Item Added");
        }

        function renderResources() {
            const vList = document.getElementById('videos-list');
            const rList = document.getElementById('resources-list');
            vList.innerHTML = ''; rList.innerHTML = '';

            appData.videos.forEach(v => {
                vList.innerHTML += `
                <div class="resource-item">
                    <div style="display:flex; align-items:center;">
                        <div class="resource-icon"><i class="fas fa-play"></i></div>
                        <div><b>${v.title}</b><br><small>${v.subject}</small></div>
                    </div>
                    <a href="${v.link}" target="_blank" class="btn btn-primary"><i class="fas fa-external-link-alt"></i></a>
                </div>`;
            });

            appData.resources.forEach(r => {
                rList.innerHTML += `
                <div class="resource-item">
                    <div style="display:flex; align-items:center;">
                        <div class="resource-icon"><i class="fas fa-file"></i></div>
                        <div><b>${r.title}</b><br><small>${r.subject}</small></div>
                    </div>
                    <a href="${r.link}" target="_blank" class="btn btn-primary"><i class="fas fa-download"></i></a>
                </div>`;
            });
        }

        // ==========================================
        // 7. DASHBOARD & DATA MGMT
        // ==========================================
        function updateDashboard() {
            // Calc Total Actual Hours
            let totalActual = 0;
            // From Subjects
            Object.values(appData.progress).forEach(subj => {
                Object.values(subj).forEach(val => totalActual += val);
            });
            // From History
            appData.history.forEach(h => totalActual += h.actual);

            const totalPlan = appData.plan.totalHours;
            const pct = Math.min(100, (totalActual / totalPlan) * 100).toFixed(1);

            document.getElementById('kpi-hours').textContent = totalActual.toFixed(1);
            document.getElementById('kpi-completion').textContent = pct + '%';
            document.getElementById('kpi-targets').textContent = appData.history.length;

            // Chart
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Remaining'],
                    datasets: [{
                        data: [totalActual, Math.max(0, totalPlan - totalActual)],
                        backgroundColor: ['#2ecc71', '#ecf0f1']
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function backupData() {
            const str = JSON.stringify(appData);
            const blob = new Blob([str], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "ca_tracker_backup.json";
            a.click();
        }

        function restoreData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                appData = JSON.parse(e.target.result);
                saveData();
                location.reload();
            };
            reader.readAsText(file);
        }

        function resetApp() {
            if(confirm("Delete all data?")) {
                localStorage.removeItem('v20_data');
                location.reload();
            }
        }

        // Init
        if (localStorage.getItem('v20_license')) initApp();
    </script>
</body>
</html>
