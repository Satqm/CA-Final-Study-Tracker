function validateLicense(licenseKey) {
    try {
        // ===== STEP 1: AGGRESSIVE INPUT SANITIZATION =====
        let cleanKey = licenseKey.trim().toUpperCase();
        cleanKey = cleanKey.replace(/\s+/g, ''); // Remove all whitespace
        
        // ===== STEP 2: HANDLE DEMO LICENSE =====
        const demoKeyClean = DEMO_LICENSE.trim().toUpperCase().replace(/\s+/g, '');
        if (cleanKey === demoKeyClean) {
            return { 
                valid: true, 
                data: { 
                    key: DEMO_LICENSE,
                    type: 'DEMO', 
                    customer: 'Demo User', 
                    expiry: '2026-12-31' 
                } 
            };
        }
        
        // ===== STEP 3: VALIDATE FORMAT (XXXX-XXXX-XXXX-C) =====
        // Remove dashes for validation
        const keyWithoutDashes = cleanKey.replace(/-/g, '');
        
        // Check if it's 13 alphanumeric characters
        if (!/^[A-Z0-9]{13}$/.test(keyWithoutDashes)) {
            return { valid: false, error: 'Invalid license key format. Expected: XXXX-XXXX-XXXX-C (13 alphanumeric characters)' };
        }
        
        // ===== STEP 4: EXTRACT PAYLOAD AND CHECKSUM =====
        const payload = keyWithoutDashes.substring(0, 12);
        const providedChecksum = keyWithoutDashes.substring(12, 13);
        
        // ===== STEP 5: WEIGHTED MODULO-36 CHECKSUM CALCULATION =====
        let sum = 0;
        let calculationSteps = [];
        
        for (let i = 0; i < payload.length; i++) {
            const charCode = payload.charCodeAt(i);
            const weight = i + 1; // 1-based position
            const product = charCode * weight;
            sum += product;
            calculationSteps.push(`${payload[i]}: ${charCode} Ã— ${weight} = ${product}`);
        }
        
        const moduloResult = sum % 36;
        const calculatedChecksum = moduloResult.toString(36).toUpperCase();
        
        // ===== STEP 6: VERIFY CHECKSUM =====
        if (calculatedChecksum !== providedChecksum) {
            console.log('Checksum validation failed:', {
                payload,
                providedChecksum,
                calculatedChecksum,
                sum,
                moduloResult,
                steps: calculationSteps
            });
            return { valid: false, error: 'Invalid license key checksum' };
        }
        
        // ===== STEP 7: ADDITIONAL VALIDATIONS =====
        const expiryDate = new Date('2026-12-31'); // Fixed expiry for now
        const currentDate = new Date();
        
        if (expiryDate < currentDate) {
            return { valid: false, error: 'License has expired' };
        }
        
        // ===== STEP 8: LICENSE DATA CONSTRUCTION =====
        // Extract customer initials from payload
        let customerName = 'Premium User';
        if (/^[A-Z]{2}/.test(payload)) {
            const firstTwo = payload.substring(0, 2);
            customerName = `${firstTwo[0]}.${firstTwo[1]}. License Holder`;
        }
        
        // Determine license type based on pattern
        let licenseType = 'PREMIUM';
        if (payload.startsWith('STU') || payload.includes('STUDENT')) {
            licenseType = 'STUDENT';
        } else if (payload.startsWith('TRIAL') || payload.includes('TRIAL')) {
            licenseType = 'TRIAL';
        }
        
        // Format key with dashes for display
        const formattedKey = payload.substring(0,4) + '-' + 
                           payload.substring(4,8) + '-' + 
                           payload.substring(8,12) + '-' + 
                           providedChecksum;
        
        // ===== STEP 9: RETURN VALID LICENSE DATA =====
        return { 
            valid: true, 
            data: { 
                key: formattedKey,
                originalKey: licenseKey,
                type: licenseType, 
                customer: customerName, 
                expiry: '2026-12-31',
                deviceId: deviceId, // Bind to current device
                checksumVerified: true,
                validationDate: new Date().toISOString()
            } 
        };
        
    } catch (error) {
        console.error('License validation error:', error);
        return { valid: false, error: 'License validation failed: ' + error.message };
    }
}
